{% extends 'base.html' %}

{% block title %}Settings{% endblock %}

{% block content %}
<div class="container">
    <div class="section">
        <h2>Settings</h2>
        <div class="card">
            <div class="card-content">
                <form action="{{ url_for('settings') }}" method="post">
                    <div class="input-field">
                        <input id="max_history" name="max_history" type="number" min="1" step="1" pattern="[0-9]*" value="{{ config.max_history }}" required aria-required="true">
                        <label for="max_history">Max History</label>
                    </div>
                    <div class="input-field">
                        <input id="hostname" name="hostname" type="text" value="{{ config.hostname }}" required aria-required="true">
                        <label for="hostname">Hostname</label>
                    </div>
                    <div class="input-field">
                        <select id="theme" name="theme" aria-label="Theme selection">
                            <option value="system" {% if config.theme == 'system' %}selected{% endif %}>Match System</option>
                            <option value="light" {% if config.theme == 'light' %}selected{% endif %}>Light</option>
                            <option value="dark" {% if config.theme == 'dark' %}selected{% endif %}>Dark</option>
                        </select>
                        <label for="theme">Theme</label>
                    </div>
                    <button class="btn waves-effect waves-light" type="submit" aria-label="Save settings">
                        Save Settings
                        <i class="material-icons right">save</i>
                    </button>
                    <button class="btn-flat waves-effect" type="submit" name="clear_history" aria-label="Clear task history">
                        Clear History
                        <i class="material-icons right">delete_sweep</i>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>Connected Hardware</h2>
        <div class="card">
            <div class="card-content">
                <p><strong>Manufacturer:</strong> {{ printer_info.manufacturer }}</p>
                <p><strong>Model:</strong> {{ printer_info.model }}</p>
                <p><strong>Connection:</strong> {{ printer_info.connection }}</p>
                <p><strong>Status:</strong> {{ printer_info.status }}</p>
                <button class="btn waves-effect waves-light" type="button" id="test-task-print-btn" aria-label="Test task print" style="margin-top: 20px;">
                    Test Task Print
                    <i class="material-icons right">print</i>
                </button>
                <button class="btn waves-effect waves-light" type="button" id="test-scf-print-btn" aria-label="Test SCF print" style="margin-top: 20px;">
                    Test SCF Print
                    <i class="material-icons right">print</i>
                </button>
            </div>
        </div>
    </div>

    <!-- Initialize Materialize select and handle test print buttons -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing Materialize selects');
            var selects = document.querySelectorAll('select');
            M.FormSelect.init(selects, {
                onOpenStart: function() { console.log('Select opened'); },
                onCloseEnd: function() { console.log('Select closed'); }
            });

            // Helper for toast feedback
            function showToast(msg, success=true) {
                M.toast({html: msg, classes: success ? 'green' : 'red'});
            }

            // Test Task Print
            document.getElementById('test-task-print-btn').addEventListener('click', function() {
                fetch('{{ url_for("test_print") }}', {method: 'POST'})
                    .then(resp => resp.text())
                    .then(txt => {
                        if (txt.includes('successful')) {
                            showToast('Test task print sent!');
                        } else {
                            showToast('Test task print failed.', false);
                        }
                    })
                    .catch(() => showToast('Test task print error.', false));
            });

            // Test SCF Print
            document.getElementById('test-scf-print-btn').addEventListener('click', function() {
                fetch('{{ url_for("test_scf_print") }}', {method: 'POST'})
                    .then(resp => resp.text())
                    .then(txt => {
                        if (txt.includes('successful')) {
                            showToast('Test SCF print sent!');
                        } else {
                            showToast('Test SCF print failed.', false);
                        }
                    })
                    .catch(() => showToast('Test SCF print error.', false));
            });
        });
    </script>
</div>
{% endblock %}